---
- hosts: lemur
  name: Upload Files
  vars: 
    aws_access_key: "{{ lookup('file', aws_backup_access_key_path) }}"
    aws_access_secret: "{{ lookup('file', aws_backup_access_secret_path) }}"

  tasks:
  ########### SSH Keys (for volumes)
  - name: Determine if SSH keys volume directory exists
    stat: path="{{ ssh_key_mount }}"
    register: ssh_keys_stat

  - name: Upload SSH keys to volume directory
    copy: 
      src: "{{ secretsPath }}/ssh_volumes/keys/{{ item }}"
      dest: "{{ ssh_key_mount }}/"
    with_items: 
      - ssh_host_dsa_key
      - ssh_host_ecdsa_key		
      - ssh_host_ed25519_key		
      - ssh_host_rsa_key
      - ssh_host_dsa_key.pub
      - ssh_host_ecdsa_key.pub		
      - ssh_host_ed25519_key.pub		
      - ssh_host_rsa_key.pub

  - name: Protect SSH Keys
    file: 
      path: "{{ ssh_key_mount }}/{{ item }}"
      mode: 0600
    with_items: 
      - ssh_host_dsa_key
      - ssh_host_ecdsa_key		
      - ssh_host_ed25519_key		
      - ssh_host_rsa_key
      - ssh_host_dsa_key.pub
      - ssh_host_ecdsa_key.pub		
      - ssh_host_ed25519_key.pub		
      - ssh_host_rsa_key.pub

  ############ SSH Authorized User (for volumes)
  - name: Determine if SSH user volume directory exists
    stat: path="{{ ssh_user_mount }}"
    register: ssh_user_stat

  - name: Upload SSH user volume to volume directory
    copy: 
      src: "{{ secretsPath }}/ssh_volumes/user/{{ item }}"
      dest: "{{ ssh_user_mount }}/"
    with_items: 
      - authorized_keys