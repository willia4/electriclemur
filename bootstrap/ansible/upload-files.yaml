---
- hosts: lemur
  name: Upload Files
  vars: 
    aws_access_key: "{{ lookup('file', aws_backup_access_key_path) }}"
    aws_access_secret: "{{ lookup('file', aws_backup_access_secret_path) }}"

  tasks:
  ########### SSH Keys (for volumes)
  - name: Determine if SSH keys volume directory exists
    stat: path="{{ vol_ssh_key_mount }}"
    register: ssh_keys_stat

  - name: Upload SSH keys to volume directory
    copy: 
      src: "{{ secretsPath }}/ssh_volumes/keys/{{ item }}"
      dest: "{{ vol_ssh_key_mount }}/"
    with_items: 
      - ssh_host_dsa_key
      - ssh_host_ecdsa_key		
      - ssh_host_ed25519_key		
      - ssh_host_rsa_key
      - ssh_host_dsa_key.pub
      - ssh_host_ecdsa_key.pub		
      - ssh_host_ed25519_key.pub		
      - ssh_host_rsa_key.pub

  - name: Protect SSH Keys
    file: 
      path: "{{ vol_ssh_key_mount }}/{{ item }}"
      mode: 0600
    with_items: 
      - ssh_host_dsa_key
      - ssh_host_ecdsa_key		
      - ssh_host_ed25519_key		
      - ssh_host_rsa_key
      - ssh_host_dsa_key.pub
      - ssh_host_ecdsa_key.pub		
      - ssh_host_ed25519_key.pub		
      - ssh_host_rsa_key.pub

  ############ SSH Authorized User (for volumes)
  - name: Determine if SSH user volume directory exists
    stat: path="{{ vol_ssh_user_mount }}"
    register: ssh_user_stat

  - name: Upload SSH user volume to volume directory
    copy: 
      src: "{{ secretsPath }}/ssh_volumes/user/{{ item }}"
      dest: "{{ vol_ssh_user_mount }}/"
    with_items: 
      - authorized_keys

  ############ Database backups
  - name: Copy database backups from S3
    shell: "docker run --rm -v '{{ vol_database_backup_id }}:/v' -e AWS_ACCESS_KEY_ID='{{aws_access_key}}' -e AWS_SECRET_ACCESS_KEY='{{aws_access_secret}}' willia4/aws_cli aws s3 sync --delete s3://com.electriclemur.databases/db1 /v"

  ############ branheatherby.com volume 

  - name: Restore branheatherby.com volume files from backup
    shell: "docker run --rm -v '{{ vol_branheatherby_com_id }}:/v' -e AWS_ACCESS_KEY_ID='{{aws_access_key}}' -e AWS_SECRET_ACCESS_KEY='{{aws_access_secret}}' willia4/aws_cli aws s3 sync --delete 's3://com.electriclemur.staticfiles/branheatherby.com' /v"

  ############ mydwynter.com volume 

  - name: Restore mydwynter.com volume files from backup
    shell: "docker run --rm -v '{{ vol_mydwynter_com_id }}:/v' -e AWS_ACCESS_KEY_ID='{{aws_access_key}}' -e AWS_SECRET_ACCESS_KEY='{{aws_access_secret}}' willia4/aws_cli aws s3 sync --delete 's3://com.electriclemur.staticfiles/mydwynter.com' /v"

  ############ mydwynterstudios.com volume 

  - name: Restore mydwynterstudios.com volume files from backup
    shell: "docker run --rm -v '{{ vol_mydwynterstudios_com_id }}:/v' -e AWS_ACCESS_KEY_ID='{{aws_access_key}}' -e AWS_SECRET_ACCESS_KEY='{{aws_access_secret}}' willia4/aws_cli aws s3 sync --delete 's3://com.electriclemur.staticfiles/mydwynterstudios.com' /v"

  ############ mydwyntertea.com volume 

  - name: Restore mydwyntertea.com volume files from backup
    shell: "docker run --rm -v '{{ vol_mydwyntertea_com_id }}:/v' -e AWS_ACCESS_KEY_ID='{{aws_access_key}}' -e AWS_SECRET_ACCESS_KEY='{{aws_access_secret}}' willia4/aws_cli aws s3 sync --delete 's3://com.electriclemur.staticfiles/mydwyntertea.com' /v"

  ############ crowglassdesign.com volume 

  - name: Restore crowglassdesign.com volume files from backup
    shell: "docker run --rm -v '{{ vol_crowglassdesign_com_id }}:/v' -e AWS_ACCESS_KEY_ID='{{aws_access_key}}' -e AWS_SECRET_ACCESS_KEY='{{aws_access_secret}}' willia4/aws_cli aws s3 sync --delete 's3://com.electriclemur.staticfiles/crowglassdesign.com' /v"
